# 检测端文档

## 系统概述

检测端是一个基于计算机视觉的人数检测系统，采用YOLO深度学习模型进行实时人数检测。系统可连接多个摄像头节点，支持双工作模式，具备完整的Web管理界面和实时监控功能。

## 技术栈

### 核心技术
- **Python 3.x** - 主要开发语言
- **Flask** - Web服务器框架
- **OpenCV** - 图像处理和摄像头控制
- **Ultralytics YOLO** - 人数检测模型
- **WebSocket** - 实时通信
- **NumPy** - 数值计算
- **Requests** - HTTP客户端

### 硬件支持
- **ESP32-CAM** - 摄像头节点
- **SGP30传感器** - CO2环境监测（可选）
- **I2C通信** - 传感器数据读取

## 系统架构

### 核心模块

#### 1. 主程序入口 (`main.py`)
- 系统初始化和配置加载
- Flask Web服务器启动
- API路由定义
- 各模块协调管理

#### 2. 检测管理器 (`detection_manager.py`)
- **双工作模式支持**：
  - **被动接收模式(Push)**：等待摄像头主动推送图像
  - **主动拉取模式(Pull)**：定时从摄像头获取图像
  - **混合模式(Both)**：同时支持两种模式
- **YOLO模型管理**：异步加载和预加载机制
- **批量图像处理**：支持多摄像头并发检测
- **检测统计**：实时统计检测数据和性能指标
- **错误处理**：完善的异常处理和重试机制

#### 3. 节点管理器 (`node_manager.py`)
- **多摄像头管理**：支持多个ESP32-CAM节点
- **图像获取**：支持JPEG和MJPEG流格式
- **节点配置**：远程配置摄像头参数（分辨率、亮度、对比度等）
- **状态监控**：实时监控节点连接状态
- **环境数据获取**：获取节点相关的环境传感器数据

#### 4. 人数检测模块 (`detect/run.py`)
- **YOLO模型封装**：基于Ultralytics YOLO
- **单图检测**：`detect()` - 检测单张图像中的人数
- **批量检测**：`detect_series()` - 批量处理多张图像
- **模型预加载**：`load_model()` - 提前加载模型提升性能

#### 5. WebSocket客户端 (`websocket_client.py`)
- **实时通信**：与Django后端建立WebSocket连接
- **命令处理**：接收和执行远程控制命令
- **状态推送**：实时推送检测结果和系统状态
- **自动重连**：连接断开时自动重连机制
- **SSL支持**：支持WSS安全连接

#### 6. 配置管理器 (`config_manager.py`)
- **配置文件管理**：JSON格式配置文件
- **默认配置**：提供完整的默认配置项
- **配置验证**：确保配置项的有效性
- **动态更新**：支持运行时配置更新

#### 7. 系统监控器 (`system_monitor.py`)
- **资源监控**：CPU、内存、磁盘使用率
- **摄像头状态**：监控摄像头连接和帧率
- **模型状态**：监控YOLO模型加载状态
- **运行模式**：监控当前工作模式
- **环境传感器**：CO2传感器数据监控

#### 8. 日志管理器 (`logger_manager.py`)
- **同步日志记录**：避免异步日志冲突
- **分级日志**：支持不同级别的日志记录
- **文件输出**：日志文件持久化存储

## 配置文件详解

### config.json 配置项

```json
{
    "mode": "push",                    // 工作模式: push/pull/both
    "interval": 3,                     // 拉取模式间隔(秒)
    "nodes": {                         // 摄像头节点配置
        "3": "192.168.43.200:81"
    },
    "save_image": true,                // 是否保存检测图像
    "preload_model": true,             // 是否预加载YOLO模型
    "terminal_id": 2,                  // 终端ID
    "server_url": "https://smarthit.top", // 服务器地址
    "api_url": "https://smarthit.top/api/upload/", // API上传地址
    "co2_enabled": true,               // 是否启用CO2传感器
    "co2_read_interval": 30,           // CO2读取间隔(秒)
    "node_config": {                   // 摄像头参数配置
        "framesize": 8,                // 分辨率等级(0-10)
        "quality": 10,                 // 图像质量(0-63)
        "brightness": 1,               // 亮度(-2到2)
        "contrast": 0,                 // 对比度(-2到2)
        "saturation": 0,               // 饱和度(-2到2)
        "special_effect": 0,           // 特效(0-6)
        "hmirror": false,              // 水平镜像
        "vflip": false                 // 垂直翻转
    }
}
```

### 分辨率对照表

| framesize | 分辨率 | 名称 |
|-----------|--------|------|
| 10 | 1600x1200 | UXGA |
| 9 | 1280x1024 | SXGA |
| 8 | 1024x768 | XGA |
| 7 | 800x600 | SVGA |
| 6 | 640x480 | VGA |
| 5 | 400x296 | CIF |
| 4 | 320x240 | QVGA |
| 3 | 240x176 | HQVGA |
| 0 | 160x120 | QQVGA |

## 工作模式详解

### 1. 被动接收模式 (Push)
- **工作原理**：启动Flask API服务器，等待摄像头主动推送图像
- **API端点**：`/api/detect/` - 接收图像数据
- **适用场景**：摄像头具备主动推送能力
- **优势**：实时性好，响应快速

### 2. 主动拉取模式 (Pull)
- **工作原理**：定时从配置的摄像头节点拉取图像
- **拉取间隔**：可配置，默认3秒
- **批量处理**：支持多摄像头并发拉取和检测
- **适用场景**：摄像头仅提供流媒体服务
- **优势**：兼容性好，控制灵活

### 3. 混合模式 (Both)
- **工作原理**：同时启动Push和Pull模式
- **适用场景**：混合部署环境
- **优势**：最大兼容性和灵活性

## Web管理界面

### 功能特性
- **实时监控面板**：显示系统状态、检测结果、摄像头状态
- **配置管理**：可视化配置系统参数
- **运行日志**：实时查看系统运行日志
- **摄像头控制**：远程配置摄像头参数
- **模式切换**：动态切换工作模式
- **系统监控**：CPU、内存使用率监控

### 访问方式
- **本地访问**：`http://localhost:5000`
- **局域网访问**：`http://[设备IP]:5000`

## API接口文档

### 检测相关接口

#### POST /api/detect/
**功能**：接收图像进行人数检测（被动模式）

**请求参数**：
- `image`: 图像文件（multipart/form-data）
- `node_id`: 摄像头节点ID

**响应格式**：
```json
{
    "status": "success",
    "count": 5,
    "message": "检测完成"
}
```

### 控制相关接口

#### POST /api/control/
**功能**：控制检测服务的启动、停止和模式切换

**请求参数**：
```json
{
    "action": "change_mode",  // start_push/stop_push/start_pull/stop_pull/change_mode
    "mode": "push"           // push/pull/both (仅change_mode时需要)
}
```

#### GET /api/environment/
**功能**：获取环境信息（CPU、内存、摄像头状态等）

**响应格式**：
```json
{
    "cpu_percent": 25.5,
    "memory_percent": 45.2,
    "nodes": {
        "3": {
            "status": "在线",
            "last_capture": "14:30:25",
            "detection_count": 15
        }
    }
}
```

## 部署与运行

### 环境要求
- **Python 3.7+**
- **pip** 包管理器
- **摄像头硬件**（ESP32-CAM等）
- **网络连接**

### 安装步骤

1. **安装依赖**：
```bash
pip install -r requirements.txt
```

2. **配置文件**：
   - 复制并修改 `config.json`
   - 配置摄像头节点地址
   - 设置服务器连接信息

3. **启动系统**：
```bash
python src/main.py
```

4. **访问界面**：
   - 打开浏览器访问 `http://localhost:5000`

### 目录结构
```
detecting_end/
├── src/                    # 源代码目录
│   ├── main.py            # 主程序入口
│   ├── detection_manager.py # 检测管理器
│   ├── node_manager.py    # 节点管理器
│   ├── websocket_client.py # WebSocket客户端
│   ├── config_manager.py  # 配置管理器
│   ├── system_monitor.py  # 系统监控器
│   ├── logger_manager.py  # 日志管理器
│   └── detect/            # 检测模块
│       ├── run.py         # YOLO检测接口
│       └── detect_model.pt # YOLO模型文件
├── static/                # 静态文件（Web界面）
│   └── index.html        # 主页面
├── config.json           # 配置文件
├── requirements.txt      # 依赖列表
├── logs/                 # 日志目录
├── captures/             # 图像保存目录
├── temp/                 # 临时文件目录
└── readme.md            # 说明文档
```

## 通信机制

### WebSocket通信
- **连接地址**：`wss://server/ws/terminal/{terminal_id}/`
- **消息格式**：JSON
- **支持功能**：
  - 实时状态推送
  - 远程命令执行
  - 检测结果上传
  - 心跳保活

### HTTP通信
- **数据上传**：POST请求上传检测结果
- **配置同步**：获取服务端配置更新
- **状态报告**：定期上报系统状态

## 性能特性

### 检测性能
- **YOLO模型**：高精度人数检测
- **批量处理**：支持多摄像头并发检测
- **模型预加载**：减少检测延迟
- **内存优化**：智能内存管理

### 系统稳定性
- **异常处理**：完善的错误处理机制
- **自动重连**：网络断开自动重连
- **资源监控**：实时监控系统资源
- **日志记录**：详细的运行日志

### 扩展性
- **模块化设计**：各模块独立，易于扩展
- **配置驱动**：通过配置文件灵活调整
- **插件化**：支持新的传感器和功能模块
- **API开放**：提供完整的API接口

## 监控与维护

### 系统监控
- **实时状态**：通过Web界面查看系统状态
- **性能指标**：CPU、内存、网络使用情况
- **检测统计**：检测次数、准确率等统计信息
- **错误追踪**：异常日志和错误统计

### 日志管理
- **分级日志**：DEBUG、INFO、WARNING、ERROR
- **文件轮转**：自动日志文件轮转
- **远程日志**：支持日志远程上传
- **实时查看**：Web界面实时日志查看

### 维护建议
- **定期检查**：定期检查摄像头连接状态
- **模型更新**：根据需要更新YOLO模型
- **配置备份**：定期备份配置文件
- **系统更新**：及时更新系统依赖

## 故障排除

### 常见问题

1. **摄像头连接失败**
   - 检查网络连接
   - 验证摄像头IP地址
   - 检查摄像头电源状态

2. **模型加载失败**
   - 检查模型文件是否存在
   - 验证Python环境和依赖
   - 检查系统内存是否充足

3. **WebSocket连接失败**
   - 检查服务器地址配置
   - 验证网络连接
   - 检查SSL证书（WSS连接）

4. **检测精度问题**
   - 调整摄像头参数（亮度、对比度）
   - 检查光照条件
   - 考虑更新YOLO模型

### 调试方法
- **日志分析**：查看详细的运行日志
- **状态监控**：通过Web界面监控系统状态
- **API测试**：使用API接口进行功能测试
- **配置验证**：检查配置文件的正确性

## 安全考虑

### 网络安全
- **HTTPS/WSS**：使用加密连接
- **访问控制**：限制Web界面访问
- **防火墙**：配置适当的防火墙规则

### 数据安全
- **图像加密**：传输过程中的图像加密
- **配置保护**：敏感配置信息保护
- **日志脱敏**：日志中的敏感信息脱敏

### 系统安全
- **权限控制**：最小权限原则
- **更新管理**：及时更新系统和依赖
- **备份策略**：重要数据定期备份