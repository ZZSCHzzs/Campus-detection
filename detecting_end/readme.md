# 检测端文档

## 系统概述

本系统是一个基于计算机视觉的人数检测系统，可连接多个摄像头，检测画面中的人数并将结果上传至云服务器。系统支持两种工作模式，适用于不同的应用场景，并提供Web界面进行实时监控和配置管理。

## 功能特点

- **多摄像头支持**：可同时连接并管理多个摄像头
- **双工作模式**：支持主动拉取和被动接收两种模式
- **实时检测**：快速分析图像中的人数
- **数据上传**：自动将检测结果上传至云端服务器
- **稳定性保障**：异常处理和错误日志记录
- **实时UI界面**：通过WebSocket实现实时数据展示和监控
- **系统监控**：CPU、内存使用率和摄像头状态监控
- **配置管理**：可视化配置系统参数，支持持久化保存

## 系统架构

系统由以下几个主要组件构成：

- **图像获取模块**：负责从摄像头获取图像
- **人数检测模块**：使用深度学习模型检测图像中的人数
- **数据上传模块**：将检测结果发送至指定服务器
- **API服务器**：在被动模式下接收图像请求
- **WebSocket服务**：实现实时UI界面通信
- **Web界面**：提供用户友好的系统管理界面

## Web界面功能

系统提供了完整的Web界面，可通过浏览器访问：

### 监控面板
- 实时显示系统状态和检测结果
- 监控摄像头连接状态
- 显示CPU和内存使用情况
- 图表展示历史检测数据

### 配置管理
- 工作模式切换（主动拉取/被动接收）
- 检测间隔时间设置
- 摄像头配置管理（添加、删除、修改）
- 其他系统参数调整

### 运行日志
- 实时显示系统日志
- 支持暂停和清空日志
- 按类型区分日志信息（错误、警告、信息）

## 通信机制

### WebSocket实时通信
系统使用WebSocket技术实现前后端实时通信，确保UI界面能够实时反映系统状态：

- **系统状态更新**：模型加载状态、摄像头连接状态等
- **检测结果推送**：实时推送最新的人数检测结果
- **资源使用情况**：定期推送CPU和内存使用率
- **错误和警告**：实时推送系统错误和警告信息

### 与服务端通信
系统通过HTTP请求与云服务器通信：

- **数据上传**：将检测结果上传至云服务器
- **配置同步**：支持从服务器获取配置更新（可选功能）

## 工作模式

### 1. 主动拉取模式 (Pull)

在此模式下，系统会定期主动从配置的摄像头获取图像，进行分析后上传结果。

- **优点**：无需外部触发，定时执行
- **适用场景**：固定位置的监控摄像头，需要定期检测的场所

### 2. 被动接收模式 (Push)

在此模式下，系统作为服务器等待客户端发送图像，收到后进行分析并返回结果。

- **优点**：按需处理，节省资源
- **适用场景**：移动设备或不需要连续监控的场所

## 配置说明

### 配置方式

系统提供两种配置方式：

1. **Web界面配置**：通过浏览器访问系统提供的配置页面进行可视化配置
2. **配置文件配置**：修改`config.json`文件（自动生成）

### 摄像头配置

在Web界面中，可以添加、删除和修改摄像头配置：
- 摄像头ID：唯一标识符
- 摄像头URL：访问地址，如`http://192.168.1.102:81`

### 工作模式设置

通过Web界面或配置文件设置：
- **主动拉取模式**：系统主动获取图像
- **被动接收模式**：等待外部发送图像

## 安装与部署

### 前置条件

- Python 3.6+
- 必要的Python库（见requirements.txt）

### 安装步骤

1. 克隆代码库
   
   ```
   git clone [repository-url]
   ```

2. 安装依赖
   
   ```
   pip install -r requirements.txt
   ```

3. 运行系统
   
   ```
   python main.py
   ```

4. 访问Web界面
   
   ```
   http://localhost:5000
   ```

## API 接口

### 被动模式接口

- **URL**: `/api/push_frame/<camera_id>`
- **方法**: POST
- **参数**: 
  - `camera_id`: 摄像头ID (整数)
  - `file`: 图像文件 (multipart/form-data)
- **返回**: 
  
  ```json
  {
    "status": "success"
  }
  ```

### 系统状态接口

- **URL**: `/api/status`
- **方法**: GET
- **返回**: 系统状态JSON

### 配置管理接口

- **URL**: `/api/config`
- **方法**: POST