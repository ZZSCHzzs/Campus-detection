#!/bin/bash
set -e

# ====== ç¯å¢ƒé…ç½® ======
SOCKET_DIR="/run/gunicorn"
SOCKET_FILE="$SOCKET_DIR/gunicorn-campus.sock"
GUNICORN_SERVICE="campus_backend.service"
DAPHNE_SERVICE="campus_daphne.service"
NGINX_SERVICE="nginx"
GUNICORN_USER="www-data"
GUNICORN_GROUP="www-data"
LOG_DIR="/var/log/gunicorn"

echo "ğŸš€ å¼€å§‹éƒ¨ç½²æµç¨‹..."

# ====== åˆ›å»º Gunicorn å¥—æ¥å­—ç›®å½• ======
echo "ğŸ“ åˆ›å»º Gunicorn socket ç›®å½•: $SOCKET_DIR"
sudo mkdir -p $SOCKET_DIR
sudo chown $GUNICORN_USER:$GUNICORN_GROUP $SOCKET_DIR
sudo chmod 775 $SOCKET_DIR

# ====== åˆ›å»ºæ—¥å¿—ç›®å½• ======
echo "ğŸ—‚ï¸ æ£€æŸ¥å¹¶åˆ›å»ºæ—¥å¿—ç›®å½•: $LOG_DIR"
sudo mkdir -p $LOG_DIR
sudo chown -R $GUNICORN_USER:$GUNICORN_GROUP $LOG_DIR
sudo chmod 755 $LOG_DIR

# ====== é‡è½½ systemd é…ç½® ======
echo "ğŸ”„ é‡è½½ systemd..."
sudo systemctl daemon-reload

# ====== é‡å¯ Gunicorn æœåŠ¡ ======
echo "ğŸ”¥ é‡å¯ Gunicorn æœåŠ¡: $GUNICORN_SERVICE"
sudo systemctl restart $GUNICORN_SERVICE
sudo systemctl enable $GUNICORN_SERVICE

# ====== é‡å¯ Daphne æœåŠ¡ ======
echo "ğŸŒ é‡å¯ Daphne æœåŠ¡: $DAPHNE_SERVICE"
sudo systemctl restart $DAPHNE_SERVICE
sudo systemctl enable $DAPHNE_SERVICE

# ====== é‡è½½ Nginx é…ç½® ======
echo "ğŸ” é‡æ–°åŠ è½½ Nginx é…ç½®..."
sudo systemctl reload $NGINX_SERVICE

# ====== æ£€æŸ¥æœåŠ¡çŠ¶æ€ ======
echo "âœ… æ£€æŸ¥æœåŠ¡çŠ¶æ€ï¼š"

echo -e "\nğŸ“¡ Gunicorn çŠ¶æ€:"
if ! sudo systemctl is-active --quiet $GUNICORN_SERVICE; then
    echo "âŒ Gunicorn å¯åŠ¨å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ—¥å¿—ï¼šsudo journalctl -u $GUNICORN_SERVICE -xe"
else
    echo "âœ… Gunicorn æ­£åœ¨è¿è¡Œ"
fi

echo -e "\nğŸ“¡ Daphne çŠ¶æ€:"
if ! sudo systemctl is-active --quiet $DAPHNE_SERVICE; then
    echo "âŒ Daphne å¯åŠ¨å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ—¥å¿—ï¼šsudo journalctl -u $DAPHNE_SERVICE -xe"
else
    echo "âœ… Daphne æ­£åœ¨è¿è¡Œ"
fi

echo -e "\nğŸŒ Nginx çŠ¶æ€:"
if ! sudo systemctl is-active --quiet $NGINX_SERVICE; then
    echo "âŒ Nginx å¯åŠ¨å¤±è´¥ï¼Œè¯·æ£€æŸ¥é…ç½®æ–‡ä»¶å¹¶ä½¿ç”¨ nginx -t"
else
    echo "âœ… Nginx æ­£åœ¨è¿è¡Œ"
fi

echo -e "\nğŸ‰ éƒ¨ç½²å®Œæˆï¼"
